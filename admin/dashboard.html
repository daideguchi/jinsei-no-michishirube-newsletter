<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - äººç”Ÿã®é“æ¨™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .zen-gradient {
            background: linear-gradient(135deg, #2C5F41 0%, #4A7C59 100%);
        }
        .admin-sidebar {
            background: linear-gradient(180deg, #1f2937 0%, #374151 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
<script src="/admin/auth-check.js"></script>
</head>
<body class="bg-gray-50">
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="admin-sidebar shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl">ğŸ›¡ï¸</span>
                    <span class="ml-2 text-xl font-bold text-white">äººç”Ÿã®é“æ¨™ ç®¡ç†è€…ç”»é¢</span>
                </div>
                <div class="flex items-center space-x-6">
                    <a href="/admin/dashboard" class="text-white font-semibold">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                    <a href="/admin/email-templates" class="text-gray-300 hover:text-white">âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</a>
                    <a href="/admin/subscribers" class="text-gray-300 hover:text-white">ğŸ‘¥ èª­è€…ç®¡ç†</a>
                    <a href="/admin/analytics" class="text-gray-300 hover:text-white">ğŸ“ˆ åˆ†æ</a>
                    <a href="/admin/settings" class="text-gray-300 hover:text-white">âš™ï¸ è¨­å®š</a>
                    <button onclick="logout()" class="text-red-300 hover:text-red-100">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">ğŸ“Š ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p class="text-gray-600 mt-2">äººç”Ÿã®é“æ¨™ãƒ¡ãƒ«ãƒã‚¬ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦</p>
            <div class="mt-4 text-sm text-gray-500">
                æœ€çµ‚æ›´æ–°: <span id="lastUpdated">2025-07-26 18:30</span>
            </div>
        </div>

        <!-- ä¸»è¦çµ±è¨ˆ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100">
                        <span class="text-2xl">ğŸ‘¥</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">ç·èª­è€…æ•°</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalSubscribers">èª­ã¿è¾¼ã¿ä¸­...</p>
                        <p class="text-xs text-green-600">â†—ï¸ <span id="newSubscribersGrowth">èª­ã¿è¾¼ã¿ä¸­...</span></p>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100">
                        <span class="text-2xl">ğŸ“§</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">ä»Šæœˆé…ä¿¡æ•°</p>
                        <p class="text-2xl font-bold text-gray-900" id="monthlyEmails">èª­ã¿è¾¼ã¿ä¸­...</p>
                        <p class="text-xs text-green-600">â†—ï¸ <span id="campaignGrowth">èª­ã¿è¾¼ã¿ä¸­...</span></p>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100">
                        <span class="text-2xl">ğŸ“ˆ</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">é–‹å°ç‡</p>
                        <p class="text-2xl font-bold text-gray-900" id="openRate">èª­ã¿è¾¼ã¿ä¸­...</p>
                        <p class="text-xs text-green-600">â†—ï¸ +2.1% vs å…ˆæœˆ</p>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100">
                        <span class="text-2xl">ğŸ–±ï¸</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">ã‚¯ãƒªãƒƒã‚¯ç‡</p>
                        <p class="text-2xl font-bold text-gray-900" id="clickRate">èª­ã¿è¾¼ã¿ä¸­...</p>
                        <p class="text-xs text-red-600">â†˜ï¸ -0.5% vs å…ˆæœˆ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒãƒ£ãƒ¼ãƒˆã¨è©³ç´°æƒ…å ± -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- é…ä¿¡çµ±è¨ˆãƒãƒ£ãƒ¼ãƒˆ -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“Š é…ä¿¡çµ±è¨ˆï¼ˆéå»30æ—¥ï¼‰</h3>
                <canvas id="emailChart" width="400" height="200"></canvas>
            </div>

            <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">âš¡ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Google Sheets é€£æº</span>
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">ğŸŸ¢ æ­£å¸¸</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Brevo API</span>
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">ğŸŸ¢ æ­£å¸¸</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">ãƒ¡ãƒ¼ãƒ«é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ </span>
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">ğŸŸ¢ ç¨¼åƒä¸­</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">è‡ªå‹•åŒ–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span>
                        <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">ğŸŸ¡ ç›£è¦–ä¸­</span>
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t">
                    <h4 class="font-semibold text-gray-900 mb-3">ğŸ”§ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h4>
                    <div class="space-y-2">
                        <button onclick="testBrevoConnection()" class="w-full text-left px-4 py-2 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                            ğŸ§ª Brevoæ¥ç¶šãƒ†ã‚¹ãƒˆ
                        </button>
                        <button onclick="syncGoogleSheets()" class="w-full text-left px-4 py-2 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                            ğŸ”„ Google SheetsåŒæœŸ
                        </button>
                        <button onclick="sendTestEmail()" class="w-full text-left px-4 py-2 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                            ğŸ“¨ ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- æœ€è¿‘ã®é…ä¿¡ -->
        <div id="recentCampaigns" class="space-y-4">
            <div class="text-center py-4 text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
        <!-- å…ƒã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ -->
        <div id="dummyCampaigns" style="display: none;">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“¬ æœ€è¿‘ã®é…ä¿¡</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-900">Day 1 - å¿ƒã‚’æ•´ãˆã‚‹æ™ºæ…§</div>
                            <div class="text-sm text-gray-600">45åã«é…ä¿¡ â€¢ 2æ™‚é–“å‰</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-green-600">32.5% é–‹å°</div>
                            <div class="text-xs text-gray-600">8.2% ã‚¯ãƒªãƒƒã‚¯</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-900">Welcome - ã”ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</div>
                            <div class="text-sm text-gray-600">23åã«é…ä¿¡ â€¢ 5æ™‚é–“å‰</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-green-600">45.2% é–‹å°</div>
                            <div class="text-xs text-gray-600">12.1% ã‚¯ãƒªãƒƒã‚¯</div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-900">Day 3 - äººé–“é–¢ä¿‚ã®æ™ºæ…§</div>
                            <div class="text-sm text-gray-600">78åã«é…ä¿¡ â€¢ 1æ—¥å‰</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-green-600">28.9% é–‹å°</div>
                            <div class="text-xs text-gray-600">6.7% ã‚¯ãƒªãƒƒã‚¯</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ–°è¦ç™»éŒ²è€… -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ†• æ–°è¦ç™»éŒ²è€…
                <div id="recentSubscribers" class="space-y-4">
                    <div class="text-center py-4 text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <!-- å…ƒã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ -->
                <div id="dummySubscribers" style="display: none;"></h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-900">ç”°ä¸­ å¥å¸</div>
                            <div class="text-sm text-gray-600">tanaka@company.com</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-600">2æ™‚é–“å‰</div>
                            <div class="text-xs text-green-600">Step 0</div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-900">ä½è—¤ æµ©äºŒ</div>
                            <div class="text-sm text-gray-600">sato@example.com</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-600">5æ™‚é–“å‰</div>
                            <div class="text-xs text-green-600">Step 1</div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-900">å±±ç”° å’Œå¤«</div>
                            <div class="text-sm text-gray-600">yamada@corp.jp</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-600">1æ—¥å‰</div>
                            <div class="text-xs text-green-600">Step 0</div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t">
                    <a href="/admin/subscribers" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        ğŸ“‹ å…¨èª­è€…ã‚’ç®¡ç† â†’
                    </a>
                </div>
            </div>
        </div>

        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»é€šçŸ¥ -->
        <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-xl p-6">
            <h3 class="text-lg font-bold text-yellow-800 mb-4">âš ï¸ é‡è¦ãªé€šçŸ¥</h3>
            <div class="space-y-3">
                <div class="flex items-start">
                    <span class="text-yellow-600 mr-3">ğŸ””</span>
                    <div>
                        <div class="font-medium text-yellow-800">å®Ÿéš›ã®APIä½¿ç”¨é‡ç›£è¦–ä¸­</div>
                        <div class="text-sm text-yellow-700">ä»Šæœˆã®APIä½¿ç”¨é‡ãŒåˆ¶é™ã«è¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚ä½¿ç”¨é‡ã‚’ç›£è¦–ã—ã¦ãã ã•ã„ã€‚</div>
                    </div>
                </div>
                <div class="flex items-start">
                    <span class="text-yellow-600 mr-3">ğŸ“Š</span>
                    <div>
                        <div class="font-medium text-yellow-800">å®Ÿéš›ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æä¸­</div>
                        <div class="text-sm text-yellow-700">ä»¶åã®æ”¹å–„ã¾ãŸã¯ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé…ä¿¡ã®æ¤œè¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
        const ctx = document.getElementById('emailChart').getContext('2d');
        const emailChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['7/20', '7/21', '7/22', '7/23', '7/24', '7/25', '7/26'],
                datasets: [{
                    label: 'é…ä¿¡æ•°',
                    data: [12, 8, 15, 23, 18, 11, 25],
                    borderColor: '#2C5F41',
                    backgroundColor: 'rgba(44, 95, 65, 0.1)',
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'é–‹å°æ•°',
                    data: [4, 3, 5, 8, 6, 4, 8],
                    borderColor: '#4A7C59',
                    backgroundColor: 'rgba(74, 124, 89, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
        function updateStats() {
            // åŸºæœ¬çµ±è¨ˆæ›´æ–°
            fetch("/api/admin/stats")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("totalSubscribers").textContent = data.totalSubscribers;
                    document.getElementById("monthlyEmails").textContent = data.monthlyEmails;
                    document.getElementById("openRate").textContent = data.openRate;
                    document.getElementById("clickRate").textContent = data.clickRate;
                    document.getElementById("lastUpdated").textContent = data.lastUpdated;
                })
                .catch(error => {
                    console.error("çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                });
            
            // æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æ›´æ–°
            fetch("/api/admin/recent-activity")
                .then(response => response.json())
                .then(data => {
                    // æˆé•·ç‡æ›´æ–°
                    document.getElementById("newSubscribersGrowth").textContent = `+${data.monthlyStats.newSubscribers} (ä»Šæœˆ)`;
                    document.getElementById("campaignGrowth").textContent = `${data.monthlyStats.growth} vs å…ˆæœˆ`;
                    
                    // æœ€è¿‘ã®é…ä¿¡æ›´æ–°
                    const campaignsDiv = document.getElementById("recentCampaigns");
                    if (data.recentCampaigns.length === 0) {
                        campaignsDiv.innerHTML = "<div class=\"text-center py-4 text-gray-500\">é…ä¿¡å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>";
                    } else {
                        campaignsDiv.innerHTML = data.recentCampaigns.map(campaign => `
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <div class="font-medium text-gray-900">${campaign.name}</div>
                                    <div class="text-sm text-gray-600">${campaign.sentCount}åã«é…ä¿¡ â€¢ ${campaign.timeAgo}</div>
                                </div>
                                <div class="text-right text-sm">
                                    <div class="text-green-600">${campaign.openRate} é–‹å°</div>
                                    <div class="text-blue-600">${campaign.clickRate} ã‚¯ãƒªãƒƒã‚¯</div>
                                </div>
                            </div>
                        `).join("");
                    }
                    
                    // æ–°è¦ç™»éŒ²è€…æ›´æ–°
                    const subscribersDiv = document.getElementById("recentSubscribers");
                    if (data.recentSubscribers.length === 0) {
                        subscribersDiv.innerHTML = "<div class=\"text-center py-4 text-gray-500\">æ–°è¦ç™»éŒ²è€…ãŒã„ã¾ã›ã‚“</div>";
                    } else {
                        subscribersDiv.innerHTML = data.recentSubscribers.map(subscriber => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <div class="font-medium text-gray-900">${subscriber.name}</div>
                                    <div class="text-sm text-gray-600">${subscriber.email}</div>
                                </div>
                                <div class="text-right text-sm text-gray-500">
                                    <div>${subscriber.timeAgo}</div>
                                    <div>${subscriber.step}</div>
                                </div>
                            </div>
                        `).join("");
                    }
                })
                .catch(error => {
                    console.error("ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                });
            fetch("/api/admin/stats")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("totalSubscribers").textContent = data.totalSubscribers;
                    document.getElementById("monthlyEmails").textContent = data.monthlyEmails;
                    document.getElementById("openRate").textContent = data.openRate;
                    document.getElementById("clickRate").textContent = data.clickRate;
                    document.getElementById("lastUpdated").textContent = data.lastUpdated;
                })
                .catch(error => {
                    console.error("çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                });
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ API ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
            const now = new Date().toLocaleString('ja-JP');
            document.getElementById('lastUpdated').textContent = now;
        }

        // ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢æ•°
        async function testBrevoConnection() {
            try {
                const response = await fetch('/api/admin/test-brevo');
                const result = await response.json();
                alert(result.success ? 'âœ… Brevoæ¥ç¶šæˆåŠŸ' : 'âŒ Brevoæ¥ç¶šå¤±æ•—: ' + result.error);
            } catch (error) {
                alert('âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: ' + error.message);
            }
        }

        async function syncGoogleSheets() {
            try {
                const response = await fetch('/api/admin/sync-sheets', { method: 'POST' });
                const result = await response.json();
                alert(result.success ? 'âœ… åŒæœŸå®Œäº†' : 'âŒ åŒæœŸå¤±æ•—: ' + result.error);
                location.reload();
            } catch (error) {
                alert('âŒ åŒæœŸå¤±æ•—: ' + error.message);
            }
        }

        async function sendTestEmail() {
            const email = prompt('ãƒ†ã‚¹ãƒˆé€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:', 'admin@example.com');
            if (!email) return;
            
            try {
                const response = await fetch('/api/admin/test-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const result = await response.json();
                alert(result.success ? 'âœ… ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†' : 'âŒ é€ä¿¡å¤±æ•—: ' + result.error);
            } catch (error) {
                alert('âŒ é€ä¿¡å¤±æ•—: ' + error.message);
            }
        }

        // 5åˆ†ã”ã¨ã«çµ±è¨ˆæ›´æ–°
        setInterval(updateStats, 5 * 60 * 1000);
        updateStats();
    </script>
</body>
</html>